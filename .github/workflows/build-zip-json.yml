# .github/workflows/build-zip-json.yml
name: Build ZIP → upload to VPS

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * 1"

permissions:
  contents: read   # only needs read now – we’re not pushing back to GitHub

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1 ▸ Check out repo (read‑only is fine)
      - uses: actions/checkout@v4

      # 2 ▸ Set up Python and build the file
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: |
          python -m pip install --upgrade pip
          pip install pandas openpyxl xlrd
          python scripts/build_zip_json.py

      # 3 ▸ Copy it to the server via SSH/SCP
      - name: Upload to VPS
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          source: "us-zips.json.gz"
          target: ${{ secrets.SERVER_PATH }}

      # (Optional) keep a copy in the repo as well
      # - name: Commit updated data file back to repo
      #   uses: stefanzweifel/git-auto-commit-action@v5
      #   with:
      #     commit_message: "chore: refresh us-zips.json.gz"
      #     file_pattern: "us-zips.json.gz"

